import { Injectable, OnModuleInit, Logger } from '@nestjs/common';
import { OutboxMigrationService } from './outbox-migration.service';

@Injectable()
export class OutboxInitService implements OnModuleInit {
  private readonly logger = new Logger(OutboxInitService.name);

  constructor(
    private readonly outboxMigration: OutboxMigrationService,
  ) {
    console.log('üèóÔ∏è OutboxInitService constructor called at:', new Date().toISOString());
  }

  async onModuleInit() {
    console.log('üöÄ OutboxInitService.onModuleInit() called at:', new Date().toISOString());
    
    try {
      this.logger.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Outbox —Ç–∞–±–ª–∏—Ü—ã...');
      
      // –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ç–∞–±–ª–∏—Ü—ã
      this.logger.log('üìã –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:', JSON.stringify({
        schema: this.outboxMigration['schema'],
        tableName: this.outboxMigration['tableName'],
        fullConfig: this.outboxMigration['config']?.database
      }, null, 2));
      
      // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      await this.outboxMigration.createTableIfNotExists();
      
      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ entity_type –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç–µ—Å—å —Å —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
      await this.outboxMigration.addEntityTypeColumnIfNotExists();
      
      this.logger.log('‚úÖ Outbox —Ç–∞–±–ª–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
    } catch (error) {
      this.logger.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Outbox —Ç–∞–±–ª–∏—Ü—ã:', error);
      // –ù–µ –±—Ä–æ—Å–∞–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      // –í production —Å—Ä–µ–¥–µ —Ç–∞–±–ª–∏—Ü–∞ –º–æ–∂–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
    }
  }
} 